name: 个人申请
description: 个人申请

trigger:
  type: webhook
  param:
    - name: pull_url
      type: STRING
      exp: $.body.json.url
    - name: action
      type: STRING
      exp: $.body.json.action
    - name: username
      type: STRING
      exp: $.body.json.pull_request.user.login
    - name: nickname
      type: STRING
      exp: $.body.json.pull_request.user.name
    - name: email
      type: STRING
      exp: $.body.json.author.email
    - name: org_name
      type: STRING
      exp: $.body.json.project.namespace
  only: (${trigger.action} === "open")

workflow:
  start:
    type: start
    targets:
      - pr-file-diff
  pr-file-diff:
    type: gitee:1.0.0-pr-file-diff
    sources:
      - start
    targets:
      - jsonpath_filepath
    param:
      access_token: ((gitee.jianmubot_token))
      pr_url: ${trigger.pull_url}
  jsonpath_filepath:
    type: jsonpath:1.0.0
    sources:
      - pr-file-diff
    targets:
      - string
    param:
      expression: '$.[*].filepath'
      data: ${pr-file-diff.diff}
  string:
    type: string:1.0.0-nodejs16.13.1
    sources:
      - jsonpath_filepath
    targets:
      - condition_isUser
    param:
      expression: '"contributors/${trigger.username}.yml"'
  condition_isUser:
    sources:
      - string
    type: condition
    expression: ${jsonpath_filepath.result}==${string.result}
    cases:
      true: jsonpath_status
      false: pr_comment_rectify1

  pr_comment_rectify1:
    type: gitee:1.0.1-pr-comment
    sources:
      - condition_isUser
    targets:
      - end
    param:
      access_token: ((gitee.jianmubot_token))
      pr_url: ${trigger.pull_url}
      repeatable: false
      comment_body: ${trigger.username}您好，请检查自己的贡献者文件名是否和Gitee登录名一致。除了自己提交的贡献者文件，其他文件不可操作。请关闭此pr，按照要求重新提交，谢谢。


  jsonpath_status:
    type: jsonpath:1.0.0
    sources:
      - condition_isUser
    targets:
      - condition_added
    param:
      expression: '$.[*].status'
      data: ${pr-file-diff.diff}

  condition_added:
    sources:
      - jsonpath_status
    type: condition
    expression: ${jsonpath_status.result}=="added"
    cases:
      true: pr_comment_tips
      false: condition_deleted

  condition_deleted:
    sources:
      - condition_added
    type: condition
    expression: ${jsonpath_status.result}=="deleted"
    cases:
      true: pr-merge
      false: pr_comment_rectify2

  pr_comment_rectify2:
    type: gitee:1.0.1-pr-comment
    sources:
      - condition_deleted
    targets:
      - end
    param:
      access_token: ((gitee.jianmubot_token))
      pr_url: ${trigger.pull_url}
      repeatable: false
      comment_body: ${trigger.username}您好，提交的贡献者文件暂不支持修改，pr将自动关闭，谢谢。

  pr-merge:
    type: gitee:1.0.0-pr-merge
    sources:
      - condition_deleted
    targets:
      - remove_org
    param:
      access_token: ((gitee.jianmubot_token))
      pr_url: ${trigger.pull_url}
  remove_org:
    type: gitee:1.0.0-member-remove
    sources:
      - pr-merge
    targets:
      - send_message_exit
    param:
      access_token: ((gitee.jianmubot_token))
      org: ${trigger.org_name}
      username: ${trigger.username}
  send_message_exit:
    type: qywx_notice:1.2.1
    sources:
      - remove_org
    targets:
      - end
    param:
      bot_webhook_url: ((charbot.webhook_url))
      mentioned_mobile_list: "[]"
      text_content: "贡献者已退出。\\n\\n昵称：${trigger.nickname}\\n用户名：${trigger.username}"
      msgtype: "text"
      mentioned_list: "[]"


  pr_comment_tips:
    type: gitee:1.0.1-pr-comment
    sources:
      - condition_added
    targets:
      - pr-assignee
    param:
      access_token: ((gitee.jianmubot_token))
      pr_url: ${trigger.pull_url}
      repeatable: false
      comment_body: |
        感谢您申请加入建木社区。看起来这可能是您第一次对建木开源项目贡献。
        您需要先签署贡献者许可协议(CLA)。请访问 https://jianmu.opencla.org/ 进行签署。
        签署后，请在此处回复(例如：我已签署)，我们将进行[验证](https://jianmu.opencla.org/check?email=${trigger.email})。谢谢。

  pr-assignee:
    type: gitee:1.0.0-pr-assignee
    sources:
      - pr_comment_tips
    targets:
      - send_message_join
    param:
      access_token: ((gitee.jianmubot_token))
      pr_url: ${trigger.pull_url}
      assignees: "ethan-liu,topshare,liamjung"

  send_message_join:
    type: qywx_notice:1.2.1
    sources:
      - pr-assignee
    targets:
      - end
    param:
      bot_webhook_url: ((charbot.webhook_url))
      mentioned_mobile_list: "[]"
      text_content: "贡献者申请加入。\\n\\n昵称：${trigger.nickname}\\n用户名：${trigger.username}\\npr链接：${trigger.pull_url}"
      msgtype: "text"
      mentioned_list: "[]"
  end:
    type: end
    sources:
      - send_message_exit
      - pr_comment_rectify2
      - pr_comment_rectify1
      - send_message_join