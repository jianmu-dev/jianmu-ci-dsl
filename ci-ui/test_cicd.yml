param:
  image_name: jianmudev/jianmu-ci-ui
  image_tag: latest

pipeline:
  name: 建木CI前端测试环境 CI/CD
  ref: jianmu_ci_ui_test_cicd
  description: 建木CI前端测试环境 CI/CD
  ssh_cmd:
    type: ssh_cmd:1.0.0
    param:
      ssh_ip: 172.20.148.86
      ssh_private_key: ((jianmu_ci.server_private_key))
      ssh_cmd: >-
        docker images
        &&
        docker ps
        &&
        cd /root/jianmu-ci
        &&
        docker tag ${global.image_name}:${global.image_tag} ${global.image_name}:temp
        &&
        docker pull ${global.image_name}:${global.image_tag}
        &&
        docker-compose stop web
        &&
        docker-compose rm -vf web
        &&
        docker-compose up -d web
        &&
        docker rmi ${global.image_name}:temp
        &&
        docker images
        &&
        docker ps
        &&
        echo done
  send_message:
    type: qywx_notice:1.0.0
    param:
      bot_webhook_url: ((charbot.webhook_url))
      mentioned_moblie_list: "[]"
      text_content: "建木CI前端测试环境更新完成。\\n\\n镜像版本：${global.image_name}:${global.image_tag}"
      msgtype: "text"
      mentioned_list: "[]"
